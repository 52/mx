#!/usr/bin/env bash
#
# USAGE:
#   mx [-?|--debug] [-h|--help] COMMAND [ARGS...]
#
# OPTIONS:
#   -?, --debug   -- Enables debug (verbose) mode.
#   -h, --help    -- Displays this help message.
#
# COMMANDS:
#   - rebuild     -- Rebuilds the system.
#   - flake       -- Enter a remote development (flake) environment.

# Get the script directory.
DIRECTORY="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Set the debug mode flag.
DEBUG=0

# Parse the command line options.
while [[ $# -gt 0 ]]; do
  case "$1" in
    -\?|--debug)
      DEBUG=1
      shift
      ;;
    -h|--help)
      sed -n '3,/^$/s/^# \?//p' "$0"
      exit 0
      ;;
    *)
      break
      ;;
  esac
done

# Assert that we have at least one subcommand.
if [[ $# -eq 0 ]]; then
  echo "[err]: No command specified"
  exit 1
fi

# Get the specified command.
COMMAND="$1"
shift

# Build the corresponding sub-script path.
SCRIPT="${DIRECTORY}/mx-${COMMAND}"
if [[ ! -x "$SCRIPT" ]]; then
  echo "[err]: Command not found"
  exit 1
fi

if [[ "$DEBUG" -eq 1 ]]; then
  echo "[dbg]: executing '$SCRIPT'"
fi

# Export the debug flag for sub-scripts.
export MX_DEBUG="$DEBUG"

# Execute the script.
exec "$SCRIPT" "$@"
